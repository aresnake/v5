# ares/ui/ui_suggestions.py

"""
Panneau UI dans Blender pour afficher et valider les suggestions d'intents IA (passives).
Permet de visualiser suggestions_pending.yaml et de les valider en un clic.
"""

import bpy
import os
import yaml
from ares.tools.validate_suggestions import validate_all
from ares.core.logger import get_logger

CONFIG_PATH = os.path.join(os.path.dirname(__file__), "..", "config", "suggestions_pending.yaml")
log = get_logger("UISuggestions")

class BLADE_PT_SuggestionsPanel(bpy.types.Panel):
    bl_idname = "BLADE_PT_SuggestionsPanel"
    bl_label = "ðŸ”Ž Suggestions d'intents (IA passive)"
    bl_space_type = "VIEW_3D"
    bl_region_type = "UI"
    bl_category = "Blade"

    def draw(self, context):
        layout = self.layout

        layout.label(text="Suggestions en attente de validation :")

        if not os.path.exists(CONFIG_PATH):
            layout.label(text="âœ… Aucune suggestion trouvÃ©e.")
            return

        with open(CONFIG_PATH, encoding="utf-8") as f:
            try:
                suggestions = yaml.safe_load(f)
            except:
                suggestions = []

        if not suggestions:
            layout.label(text="âœ… Aucune suggestion dÃ©tectÃ©e.")
            return

        for intent in suggestions:
            name = intent.get("name", "(sans nom)")
            phrase = intent.get("phrase", "(sans phrase)")
            layout.label(text=f"â€¢ {phrase} ({name})")

        layout.separator()
        layout.operator("blade.validate_suggestions", icon="CHECKMARK")

class BLADE_OT_ValidateSuggestions(bpy.types.Operator):
    bl_idname = "blade.validate_suggestions"
    bl_label = "âœ… Valider toutes les suggestions"

    def execute(self, context):
        validate_all()
        self.report({'INFO'}, "Suggestions validÃ©es et injectÃ©es.")
        return {'FINISHED'}

def register():
    bpy.utils.register_class(BLADE_PT_SuggestionsPanel)
    bpy.utils.register_class(BLADE_OT_ValidateSuggestions)

def unregister():
    bpy.utils.unregister_class(BLADE_PT_SuggestionsPanel)
    bpy.utils.unregister_class(BLADE_OT_ValidateSuggestions)
